---
title: "Check Data Generating Function"
author: "Lacey Etzkorn"
date: "1/23/2022"
output: html_document
---

```{r setup, include=FALSE}
load("../simulation_results/metaData.rdata")
knitr::opts_chunk$set(echo = TRUE)
library(frailtypack); library(tidyverse)
source("../delirium_package/R/joint_simulate_data.R")
source("../delirium_package/R/competing_simulate_data.R")
source("../delirium_package/R/random_weibull.R")
results <- tibble()
```


```{r}
meta1 <- filter(meta, sigma == .75, alpha1 == 0.5, alpha2 == 0,
         trtR == -0.25, trtD == -0.25, trtD2 == 0) %>%
	filter(simid==min(simid))
data0 <- simulate.competing.data(
	n = 10000,truncate = 28,
	par0 = unlist(dplyr::select(meta1, betaR:trtD2))) 

data0 %>%
	group_by(id) %>%
	summarise(
	         w = w[1],
	         event = sum(event),
	         trt = mean(trt),
	         terminal1 = sum(terminal1),
	         terminal2 = sum(terminal2),
	         t = max(t)) %>%
	ungroup %>%
	group_by(terminal1, terminal2, trt) %>%
	summarise(n = n(),
	          st = sum(t),
	          terminalPct = 100*n/sum(n),
	          .groups = "drop",
	          anyevent = sum(event>0),
	       event = sum(event),
	       eventsPer100Day = 100*event / st) %>%
	ungroup %>%
	group_by(trt) %>% 
	mutate(anyevent.trt = 100*sum(anyevent)/sum(n),
	       eventsPer100Day.trt = 100*sum(event) / sum(st)) %>%
	arrange(trt, desc(n))
```
### Effect on Death

```{r}
meta1 <- filter(meta, sigma == .75, alpha1 == 0.5, alpha2 == -0.5,
         trtR == -0.25, trtD == -0.25, trtD2 == -0.25) %>%
	filter(simid==min(simid))
data1 <- simulate.competing.data(
	n = 10000,truncate = 28,
	par0 = unlist(dplyr::select(meta1, betaR:trtD2))) 

data1 %>%
	group_by(id) %>%
	summarise(
	         w = w[1],
	         event = sum(event),
	         trt = mean(trt),
	         terminal1 = sum(terminal1),
	         terminal2 = sum(terminal2),
	         t = max(t)) %>%
	ungroup %>%
	group_by(terminal1, terminal2, trt) %>%
	summarise(n = n(),
	          st = sum(t),
	          terminalPct = 100*n/sum(n),
	          .groups = "drop",
	          anyevent = sum(event>0),
	       event = sum(event),
	       eventsPer100Day = 100*event / st) %>%
	ungroup %>%
	group_by(trt) %>% 
	mutate(anyevent.trt = 100*sum(anyevent)/sum(n),
	       eventsPer100Day.trt = 100*sum(event) / sum(st)) %>%
	arrange(trt, desc(n))
```
