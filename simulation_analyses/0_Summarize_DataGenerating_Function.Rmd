---
title: "Check Data Generating Function"
author: "Lacey Etzkorn"
date: "1/23/2022"
output: html_document
---

```{r setup, include=FALSE}
load("../simulation_results/metaData.rdata")
knitr::opts_chunk$set(echo = TRUE)
library(frailtypack); library(tidyverse)
source("../delirium_package/R/joint_simulate_data.R")
source("../delirium_package/R/competing_simulate_data.R")
source("../delirium_package/R/random_weibull.R")
results <- tibble()
summarise.data <- function(d){
	d %>%
	group_by(id) %>%
	summarise(
	         event = sum(event),
	         trt = mean(trt),
	         terminal1 = sum(terminal1),
	         terminal2 = sum(terminal2),
	         t = max(t)) %>%
	ungroup %>%
	group_by(terminal1, terminal2, trt) %>%
	summarise(n = n(),
	          st = sum(t),
	          terminalPct = 100*n/sum(n),
	          .groups = "drop",
	          anyevent = sum(event>0),
	       event = sum(event),
	       eventsPer100Day = 100*event / st) %>%
	ungroup %>%
	group_by(trt) %>% 
	mutate(anyevent.trt = 100*sum(anyevent)/sum(n),
	       eventsPer100Day.trt = 100*sum(event) / sum(st), 
		   pct = n / sum(n)*100, 
		   anyevent = anyevent/n*100) %>%
	arrange(trt, desc(n))
}
```

### Independent Discharge

```{r}
data1 <- simulate.competing.data(
	n = 100000,truncate = 28,version=2,
	par0 =c(shapeR = 1.5, 
	         scaleR = 10,
	         shapeM = 1.75, 
	         scaleM = 16,
	         shapeD = 1.75, 
	         scaleD = 16,
	         sigma = 0.5,
	         alphaM = 1,
	         alphaD = 0,
	         betaR = -0.5,
	         betaM = -0.5,
	         betaD = 0)) 

summarise.data(data1) %>% arrange(trt, terminal1, terminal2)
```

### Association between Delirium and Mortality

```{r}
data0 <- simulate.competing.data(
	n = 10000,truncate = 28,version=2,
	par0 =c(shapeR = 1.5, 
	         scaleR = 10,
	         shapeM = 1.75, 
	         scaleM = 16,
	         shapeD = 1.75, 
	         scaleD = 16,
	         sigma = 0.5,
	         alphaM = 1,
	         alphaD = 0,
	         betaR = 0,
	         betaM = 0,
	         betaD = 0)) 

summarise.data(data0)
```

### Association between Delirium and Mortality, Delirium and Discharge

```{r}
data0 <- simulate.competing.data(
	n = 10000,truncate = 28,version=2,
	par0 =c(shapeR = 1.5, 
	         scaleR = 10,
	         shapeM = 1.75, 
	         scaleM = 16,
	         shapeD = 1.75, 
	         scaleD = 16,
	         sigma = 0.5,
	         alphaM = 1,
	         alphaD = -1,
	         betaR = 0,
	         betaM = 0,
	         betaD = 0)) 

summarise.data(data0)
```

### Association between Delirium and Mortality, Delirium and Discharge

```{r}
data0 <- simulate.competing.data(
	n = 10000,truncate = 28,version=2,
	par0 =c(shapeR = 1.5, 
	         scaleR = 10,
	         shapeM = 1.75, 
	         scaleM = 16,
	         shapeD = 1.75, 
	         scaleD = 16,
	         sigma = 0.5,
	         alphaM = 1,
	         alphaD = -1,
	         betaR = 0,
	         betaM = 0,
	         betaD = 0)) 

summarise.data(data0)
```

# Decrease Prevalence of Mortality

### Null Model, but time to death is increased so prevalence of death is roughly 25%

```{r}
data2 <- simulate.competing.data(
	n = 10000,truncate = 28,version=2,
	par0 =c(shapeR = 1.5, 
	         scaleR = 10,
	         shapeM = 1.75, 
	         scaleM = 29,
	         shapeD = 1.75, 
	         scaleD = 16,
	         sigma = 0.5,
	         alphaM = 1,
	         alphaD = 0,
	         betaR = -0.5,
	         betaM = -0.5,
	         betaD = 0)) 

summarise.data(data2)
```

### Null Model, but time to death is increased so prevalence of death is roughly 12.5%

```{r}
data3 <- simulate.competing.data(
	n = 10000,truncate = 28,version=2,
	par0 =c(shapeR = 1.5, 
	         scaleR = 10,
	         shapeM = 1.75, 
	         scaleM = 47,
	         shapeD = 1.75, 
	         scaleD = 16,
	         sigma = 0.5,
	         alphaM = 1,
	         alphaD = 0,
	         betaR = -0.5,
	         betaM = -0.5,
	         betaD = 0)) 

summarise.data(data3)
```

## Plot Hazard Functions

```{r}
f1 <- survfit(Surv(t, terminal1) ~ 1, data = filter(data1, event==0))
f2 <- survfit(Surv(t, terminal1) ~ 1, data = filter(data2, event==0))
f3 <- survfit(Surv(t, terminal1) ~ 1, data = filter(data3, event==0))
g1 <- survfit(Surv(t, terminal2) ~ 1, data = filter(data1, event==0))
g2 <- survfit(Surv(t, terminal2) ~ 1, data = filter(data2, event==0))
g3 <- survfit(Surv(t, terminal2) ~ 1, data = filter(data3, event==0))
r1 <- survfit(
	Surv(t, event) ~ 1, 
	data = data1 %>% 
	group_by(id)%>%
	filter(t == min(t)) %>%
	ungroup
)
r2 <- survfit(
	Surv(t, event) ~ 1, 
	data = data2 %>% 
	group_by(id)%>%
	filter(t == min(t)) %>%
	ungroup
)
r3 <- survfit(
	Surv(t, event) ~ 1, 
	data = data3 %>% 
	group_by(id)%>%
	filter(t == min(t)) %>%
	ungroup
)


sfits <- tibble(
	scenario = c(rep(1, length(f1$time)),rep(2, length(f2$time)),rep(3, length(f3$time)),
				 rep(1, length(g1$time)),rep(2, length(g2$time)),rep(3, length(g3$time)),
				 rep(1, length(r1$time)),rep(2, length(r2$time)),rep(3, length(r3$time))),
	t = c(f1$time, f2$time, f3$time, g1$time, g2$time, g3$time, r1$time, r2$time, r3$time),
	s = c(f1$surv, f2$surv, f3$surv, g1$surv, g2$surv, g3$surv, r1$surv, r2$surv, r3$surv),
	terminal = c(
		rep("Mortality", length(f1$time)+length(f2$time)+length(f3$time)),
	    rep("Discharge", length(f1$time)+length(f2$time)+length(f3$time)),
		rep("First Delirium", length(r1$time)+length(r2$time)+length(r3$time))
	)
)
sfuncs <- 
tibble(t = seq(0, 28, by=0.25),
	   Discharge.0 = 1-pweibull(t, shape = 1.75, scale = 16),
	   Mortality.1 = 1-pweibull(t, shape = 1.75, scale = 16),
	   Mortality.2 = 1-pweibull(t, shape = 1.75, scale = 29),
	   Mortality.3 = 1-pweibull(t, shape = 1.75, scale = 47), 
	   `First Delirium.0` = 1-pweibull(t, shape = 1.5, scale = 10)) %>%
pivot_longer(
	cols = Discharge.0:`First Delirium.0`, 
	values_to = "s",
	names_to = c("terminal", "scenario"), 
	names_sep = "\\.")

ggplot() +
geom_line(
	data = sfuncs,
	linetype = 2,
	aes(
	 x = t, 
	 y = s, 
	 group = scenario, color = scenario),) +
geom_line(data = sfits,
  aes(
	x = t, 
	y = s, 
	color = factor(scenario), 
	group = factor(scenario))) + 
facet_wrap("terminal", nrow = 1) +
scale_color_manual("Scenario",values = c("black","#005AB5","#DC3220","#FFC20A"))
```

# Figure 3 in Paper

```{r}
data4 <- simulate.competing.data(
	n = 100000,truncate = 28,version=2,
	par0 =c(shapeR = 1.5, 
	         scaleR = 10,
	         shapeM = 1.75, 
	         scaleM = 16,
	         shapeD = 1.75, 
	         scaleD = 16,
	         sigma = 0.5,
	         alphaM = 1,
	         alphaD = -1,
	         betaR = -0.5,
	         betaM = -0.5,
	         betaD = 0.5)) 
summarise.data(data4)
```

```{r}
n.trt <- data4 %>% group_by(id) %>% summarise(trt = mean(trt)) %>% summarise(sum(trt)) %>% unlist
n.ctr <- 100000-n.trt

####### Survival Functions
f1 <- survfit(Surv(t, terminal1) ~ 1, 
			  data = filter(data4, event==0))
f1.ctr <- survfit(Surv(t, terminal1) ~ 1, 
			  data = filter(data4, event==0 & trt==0))
f1.trt <- survfit(Surv(t, terminal1) ~ 1, 
			  data = filter(data4, event==0 & trt==1))
g1 <- survfit(Surv(t, terminal2) ~ 1, 
			  data = filter(data4, event==0))
g1.ctr <- survfit(Surv(t, terminal2) ~ 1, 
			  data = filter(data4, event==0& trt==0))
g1.trt <- survfit(Surv(t, terminal2) ~ 1, 
			  data = filter(data4, event==0& trt==1))
r1 <- survfit(
	Surv(t, event) ~ 1, 
	data = data4 %>% 
	group_by(id)%>%
	filter(t == min(t)) %>%
	ungroup
)
r1.trt <- survfit(
	Surv(t, event) ~ 1, 
	data = data4 %>% 
	group_by(id)%>%
	filter(t == min(t)& trt==1) %>%
	ungroup
)
r1.ctr <- survfit(
	Surv(t, event) ~ 1, 
	data = data4 %>% 
	group_by(id)%>%
	filter(t == min(t) & trt == 0) %>%
	ungroup
)

sfits <- tibble(
	t = c(f1$time,  g1$time, r1$time),
	s = c(f1$surv,  g1$surv, r1$surv),
	terminal = c(
		rep("Mortality", length(f1$time)),
	    rep("Discharge", length(f1$time)),
		rep("First Delirium Episode", length(r1$time))
	)
)

###### Cumulative Incidence Functions
rci <- data4 %>% 
	group_by(id) %>%
	filter(event==1) %>%
	filter(t == min(t)) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (100000-(1:n()))/100000)

rci.trt <- data4 %>% 
	group_by(id)%>%
	filter(trt==1) %>%
	filter(t == min(t)) %>%
	filter(event==1) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (n.trt-(1:n()))/n.trt)

rci.ctr <- data4 %>% 
	group_by(id)%>%
	filter(trt ==0) %>%
	filter(t == min(t)) %>%
	filter(event==1) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (n.ctr-(1:n()))/n.ctr)

mci <- data4 %>% 
	group_by(id)%>%
	filter(terminal1==1) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (100000-(1:n()))/100000)

mci.trt <- data4 %>% 
	group_by(id)%>%
	filter(trt==1) %>%
	filter(terminal1==1) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (n.trt-(1:n()))/n.trt)

mci.ctr <- data4 %>% 
	group_by(id)%>%
	filter(trt ==0) %>%
	filter(terminal1==1) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (n.ctr-(1:n()))/n.ctr)

dci <- data4 %>% 
	group_by(id)%>%
	filter(terminal2==1) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (100000-(1:n()))/100000)

dci.trt <- data4 %>% 
	group_by(id)%>%
	filter(trt==1) %>%
	filter(terminal2==1) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (n.trt-(1:n()))/n.trt)

dci.ctr <- data4 %>% 
	group_by(id)%>%
	filter(trt ==0) %>%
	filter(terminal2==1) %>%
	ungroup %>%
	arrange(t) %>%
	mutate(ci = (n.ctr-(1:n()))/n.ctr)


ci.fits <- tibble(
	t = c(mci$t,  dci$t, rci$t),
	ci = c(mci$ci,  dci$ci, rci$ci),
	terminal = c(
		rep("Mortality", length(mci$t)),
	    rep("Discharge", length(dci$t)),
		rep("First Delirium Episode", length(rci$t))
	)
)

###### TRUE Survival Functions
sfuncs <- 
tibble(t = seq(0, 28, by=0.25),
	   Discharge = 1-pweibull(t, shape = 1.75, scale = 16),
	   Mortality = 1-pweibull(t, shape = 1.75, scale = 16),
	   `First Delirium Episode` = 1-pweibull(t, shape = 1.5, scale = 10)) %>%
pivot_longer(
	cols = Discharge:`First Delirium Episode`, 
	values_to = "s",
	names_to = c("terminal"))

{
png("../simulation_results/Survival_Functions.png", height = 500, width = 1000)
print(
	ggplot() +
## True Functions
	geom_line(
		data = sfuncs,
		linetype = 2,size = 1,
		aes(
		 x = t, 
		 y = s)) +
## Kaplan Meyer Curves
	geom_line(data = sfits, size = 1,
	  aes(
		x = t, 
		y = s)) + 
## Cumulative Incidence Curves
	geom_line(data = ci.fits, size = 1, linetype = 3, color = "red",
	  aes(
		x = t, 
		y = ci)) + 
	facet_wrap("terminal", nrow = 1)+
	scale_x_continuous("Time Since Enrollment (days)", 
					   breaks = c(0,7,14,21,28)) +
	ylab("Survival Function") + 
	theme_bw(25)
)
dev.off()
}
knitr::include_graphics("../simulation_results/Survival_Functions.png")
```


### Survival Functions by Treatment

```{r}
###### TRUE Survival Functions
sfuncs <- 
tibble(t = seq(0, 28, by=0.25),
	   Discharge_Control = 1-pweibRH(t, shape = 1.75, scale = 16, rh = 1),
	   Mortality_Control = 1-pweibRH(t, shape = 1.75, scale = 16, rh = 1),
	   `First Delirium Episode_Control` = 1-pweibRH(t, shape = 1.5, scale = 10, rh = 1),
	   Discharge_Treated = 1-pweibRH(t, shape = 1.75, scale = 16, rh = exp(0.5)),
	   Mortality_Treated = 1-pweibRH(t, shape = 1.75, scale = 16, rh = exp(-0.5)),
	   `First Delirium Episode_Treated` = 1-pweibRH(t, shape = 1.5, scale = 10, rh = exp(-0.5))) %>%
pivot_longer(
	cols = Discharge_Control:`First Delirium Episode_Treated`, 
	values_to = "s",
	names_to = c("terminal")) %>%
separate(terminal, into = c("terminal", "treatment"),sep = "_")

###### Fitted Survival Functions
sfits <- tibble(
	t = c(f1.trt$time, f1.ctr$time, g1.trt$time, g1.ctr$time, r1.trt$time, r1.ctr$time),
	s = c(f1.trt$surv, f1.ctr$surv, g1.trt$surv, g1.ctr$surv, r1.trt$surv, r1.ctr$surv),
	terminal = c(
		rep("Mortality", length(c(f1.trt$time, f1.ctr$time))),
	    rep("Discharge", length(c(g1.trt$time, g1.ctr$time))),
		rep("First Delirium Episode", length(c(r1.trt$time, r1.ctr$time)))
	),
	treatment = c(
		rep("Treated",length(f1.trt$time)), 
		rep("Control",length(f1.ctr$time)), 
		rep("Treated",length(g1.trt$time)), 
		rep("Control",length(g1.ctr$time)), 
		rep("Treated",length(r1.trt$time)), 
		rep("Control",length(r1.ctr$time))
	)
)

{
png("../simulation_results/Survival_Treatment_Functions.png", height = 500, width = 1000)
print(
	ggplot() +
	geom_line(data =sfits,
	  aes(
		x = t, 
		y = s, 
		color = treatment)) + 
	geom_line(data =sfuncs,
	  aes(
		x = t, 
		y = s, 
		color = treatment), linetype = 2) + 	
		facet_wrap("terminal", nrow = 1)+
	scale_x_continuous("Time Since Enrollment (days)", 
					   breaks = c(0,7,14,21,28)) +
	ylab("Survival Function") + ylim(0,1)+
	theme_bw(25) +
	theme(legend.position = c(.9,.8), legend.background = element_rect(color = "grey80")) +
	scale_color_manual("Treatment", values = c("#d55e00","#0072b2"))
)
dev.off()
}
knitr::include_graphics("../simulation_results/Survival_Treatment_Functions.png")
```

### Cumulative Incidence Functions by Treatment

```{r}
{
png("../simulation_results/Cumulative_Incidence_Functions.png", height = 500, width = 1000)
print(
	
bind_rows(
	mutate(mci.trt, terminal = "Mortality"), 
	mutate(mci.ctr, terminal = "Mortality"),
	mutate(dci.trt, terminal = "Discharge"), 
	mutate(dci.ctr, terminal = "Discharge"), 
	mutate(rci.trt, terminal = "First Delirium Episode"), 
	mutate(rci.ctr, terminal = "First Delirium Episode"))%>%
	ggplot() +
## Cumulative Incidence Curves
	geom_line(
	  aes(
		x = t, 
		y = 1-ci, color = factor(trt))) + 
	facet_wrap("terminal", nrow = 1)+
	scale_x_continuous("Time Since Enrollment (days)", 
					   breaks = c(0,7,14,21,28)) +
	ylab("Cumulative Incidence Function") + ylim(0,1)+
	theme_bw(25) +
	theme(legend.position = c(.8,.8), legend.background = element_rect(color = "grey80")) +
	scale_color_manual("Treatment", values = c("#d55e00","#0072b2"))
)
dev.off()
}
knitr::include_graphics("../simulation_results/Cumulative_Incidence_Functions.png")
```
